{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Driver's License{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4">Upload Your Philippine Driver's License</h1>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <p class="card-text">Please upload a clear image of your Philippine driver's license. The image should be in landscape orientation.</p>

                    <form method="post" enctype="multipart/form-data" id="license-form">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="license_image" class="form-label">License Image</label>
                            <input type="file" class="form-control" id="license_image" name="license_image" accept="image/*" required>
                        </div>

                        <div class="mb-3">
                            <label for="license_number" class="form-label">License Number</label>
                            <input type="text" class="form-control" id="license_number" name="license_number"
                                   value="{{ extracted_license_number|default:user_profile.license_number }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="license_expiration" class="form-label">Expiration Date</label>
                            <input type="date" class="form-control" id="license_expiration" name="license_expiration"
                                   value="{{ extracted_expiration_date|default:user_profile.license_expiration|date:'Y-m-d' }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name"
                                   value="{{ extracted_name|default:user_profile.user.get_full_name }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="3" required>{{ extracted_address|default:user_profile.address }}</textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="upload-button">Upload License</button>
                            <button type="button" class="btn btn-secondary" id="confirm-button" style="display: none;">Confirm Information</button>
                        </div>
                    </form>

                    <div id="preview-container" class="mt-4" style="display: none;">
                        <h3 class="h5 mb-3">Preview</h3>
                        <img id="preview-image" src="#" alt="License Preview" class="img-fluid rounded">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('license_image').addEventListener('change', function(event) {
        var file = event.target.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            var previewContainer = document.getElementById('preview-container');
            var previewImage = document.getElementById('preview-image');
            previewImage.src = e.target.result;
            previewContainer.style.display = 'block';

            // Submit the form to process the image
            document.getElementById('license-form').submit();
        }
        reader.readAsDataURL(file);
    });

    // If we have extracted information, show the confirm button and hide the upload button
    if (document.getElementById('license_number').value || document.getElementById('license_expiration').value) {
        document.getElementById('upload-button').style.display = 'none';
        document.getElementById('confirm-button').style.display = 'block';
    }

    document.getElementById('confirm-button').addEventListener('click', function() {
        document.getElementById('license-form').submit();
    });
</script>
{% endblock %}