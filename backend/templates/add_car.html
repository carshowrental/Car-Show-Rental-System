{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Add New Car - DriveEasy Admin{% endblock %}

{% block extra_css %}
<style>
    .image-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .image-preview img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 style="color: var(--primary-color);">Add New Car</h1>
    <a href="{% url 'admin_car_list' %}" class="btn btn-secondary">Back to Cars</a>
</div>
<div class="card shadow mb-4">
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="add-car-form">
            {% csrf_token %}
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="brand" class="form-label">Brand</label>
                    <input type="text" class="form-control" id="brand" name="brand" required>
                </div>
                <div class="col-md-6">
                    <label for="model" class="form-label">Model</label>
                    <input type="text" class="form-control" id="model" name="model" required>
                </div>
                <div class="col-md-4">
                    <label for="year" class="form-label">Year</label>
                    <input type="number" class="form-control" id="year" name="year" required>
                </div>
                <div class="col-md-4">
                    <label for="car_type" class="form-label">Car Type</label>
                    <select class="form-select" id="car_type" name="car_type" required>
                        {% for value, display in car_types %}
                            <option value="{{ value }}">{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="price_per_day" class="form-label">Price per Day</label>
                    <input type="number" step="0.01" class="form-control" id="price_per_day" name="price_per_day" required>
                </div>
                <div class="col-12">
                    <label for="features" class="form-label">Features</label>
                    <textarea class="form-control" id="features" name="features" rows="3"></textarea>
                </div>
                <div class="col-12">
                    <label for="images" class="form-label">Car Images</label>
                    <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                    <div class="form-text">Select multiple images to upload.</div>
                    <div id="image-preview" class="image-preview mt-2"></div>
                </div>
            </div>
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>Add Car
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('images').addEventListener('change', function(event) {
    const preview = document.getElementById('image-preview');
    preview.innerHTML = '';
    const files = event.target.files;

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();

        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            preview.appendChild(img);
        }

        reader.readAsDataURL(file);
    }
});

document.getElementById('add-car-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    }).then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Car added successfully!');
            window.location.href = "{% url 'admin_car_list' %}";
        } else {
            alert('Error adding car. Please try again.');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
});
</script>
{% endblock %}